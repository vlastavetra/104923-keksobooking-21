(()=>{"use strict";window.util={getRandomNumber:e=>Math.round(Math.random()*e),getRandomElement:e=>e[Math.round(Math.random()*Math.round(e.length-1))],getRandomArray:(e,t)=>{let n=[];for(let o=0;o<e;o++){let e=window.util.getRandomNumber(t.length-1);n.push(t[e]),t.splice(e,1)}return n},disableElements:(e,t)=>{for(let n=0;n<e.length;n++)e[n].disabled=t,!0===t&&(e[n].style.cursor="default")},showElement:(e,t)=>{e.classList.remove(t)},hideElement:(e,t)=>{e.classList.add(t)},createErrorMessage:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},removePins:()=>{window.const.MAP.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},noop:()=>{}},(()=>{const e="GET",t="POST",n="https://21.javascript.pages.academy/keksobooking/data",o="https://21.javascript.pages.academy/keksobooking";let i=(e,t,n,o=window.util.noop)=>{let i=new XMLHttpRequest;return i.responseType="json",i.open(e,t),i.timeout=1e4,((e,t,n)=>{e.addEventListener("load",(()=>{200===e.status?t(e.response):n("Статус ответа: "+e.status+" "+e.statusText)})),e.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+e.timeout+"мс")}))})(i,n,o),i};window.backend={loadData:(t,o)=>{i(e,n,t,o).send()},saveData:(e,n,r)=>{i(t,o,n,r).send(e)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("[name='address']"),n=document.querySelector(".map"),o=Array.from(e.querySelectorAll(".ad-form > fieldset")),i=n.querySelector(".map__filters-container"),r=document.querySelector(".map__filters"),d=Array.from(r.children),s=document.querySelector(".map__pin--main");window.const={AD_FORM:e,ADDRESS:t,AD_FORM_FILDSETS:o,MAP_FILTER:i,MAP_FILTERS_CHILDS:d,MAP_FILTERS:r,MAP_PIN_MAIN:s,MAP:n,TUMBLER:"hidden"}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=1e4;window.filter={filterOffers:t=>{window.const.MAP_FILTERS.addEventListener("change",window.debounce((()=>{const n=Object.fromEntries(new FormData(window.const.MAP_FILTERS).entries()),o=t.filter((e=>e.offer.type===n["housing-type"]||"any"===n["housing-type"])).filter((e=>e.offer.rooms===parseInt(n["housing-rooms"],10)||"any"===n["housing-rooms"])).filter((e=>e.offer.guests===parseInt(n["housing-guests"],10)||"any"===n["housing-guests"])).filter((t=>{switch(n["housing-price"]){case"low":return t.offer.price<e;case"middle":return t.offer.price>=e&&t.offer.price<=5e4;case"high":return t.offer.price>e;default:return t}})).filter((e=>e.offer.features.includes(n.features)||void 0===n.features));window.util.removePins(),window.offer.renderOffers(o)})))}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector("button");window.pin={renderPin:t=>{const n=e.cloneNode(!0),o=n.querySelector("img");return o.src=t.author.avatar,o.alt=t.offer.title,n.style.left=t.location.x-n.offsetWidth/2+"px",n.style.top=t.location.y-n.offsetHeight+"px",n.addEventListener("click",(()=>{const e=window.const.MAP.querySelector(".map__card");e&&e.remove(),window.const.MAP.insertBefore(window.offer.renderOffer(t),window.const.MAP_FILTER)})),n}}})(),(()=>{const e=["gif","jpg","jpeg","png","svg"],t={AVATAR:window.const.AD_FORM.querySelector(".ad-form__field input[type=file]"),PHOTO:window.const.AD_FORM.querySelector(".ad-form__upload input[type=file]")},n=window.const.AD_FORM.querySelector(".ad-form-header__preview img"),o=window.const.AD_FORM.querySelector(".ad-form__photo");let i=document.createElement("img");i.width=70,i.height=70;let r=[n,o.appendChild(i)];[t.AVATAR,t.PHOTO].forEach(((t,n)=>{t.addEventListener("change",(()=>{let o=t.files[0],i=o.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{r[n].src=e.result})),e.readAsDataURL(o)}}))}))})(),(()=>{const e=document.querySelector(".map__pins"),t=document.createDocumentFragment(),n=document.querySelector("#card").content.querySelector(".popup");window.offer={renderOffer:e=>{const t=n.cloneNode(!0),o={TITLE:t.querySelector(".popup__title"),ADDRESS:t.querySelector(".popup__text--address"),PRICE:t.querySelector(".popup__text--price"),TYPE:t.querySelector(".popup__type"),CAPACITY:t.querySelector(".popup__text--capacity"),TIME:t.querySelector(".popup__text--time"),FEATURES:t.querySelector(".popup__features"),DESCRIPTION:t.querySelector(".popup__description"),AVATAR:t.querySelector(".popup__avatar"),PHOTOS:t.querySelector(".popup__photos")},i=o.PHOTOS.querySelector(".popup__photo"),r=t.querySelector(".popup__close");return o.ADDRESS.textContent=e.offer.address,o.PRICE.textContent=e.offer.price.toLocaleString()+" ₽/ночь",o.TITLE.textContent=e.offer.title,o.CAPACITY.textContent=e.offer.rooms+" комнаты для "+e.offer.guests+" гостей",o.TIME.textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,o.DESCRIPTION.textContent=e.offer.description,o.AVATAR.src=e.author.avatar,o.TYPE.textContent={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"}[e.offer.type],e.offer.photos.forEach((e=>{const t=i.cloneNode(!0);t.src=e,o.PHOTOS.appendChild(t)})),i.remove(),e.offer.features.forEach((e=>{window.util.showElement(o.FEATURES.querySelector(".popup__feature--"+e),window.const.TUMBLER)})),window.offer.closeOffer(t,r),t},closeOffer:(e,t)=>{t.addEventListener("click",(()=>{window.util.hideElement(e,window.const.TUMBLER)})),t.addEventListener("keydown",(t=>{"Enter"===t.key&&window.util.hideElement(e,window.const.TUMBLER)})),window.const.MAP_FILTERS.addEventListener("change",(()=>{window.util.hideElement(e,window.const.TUMBLER)})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&window.util.hideElement(e,window.const.TUMBLER)}))},renderOffers:n=>{if(n.length>=5)for(let e=0;e<5;e++)t.appendChild(window.pin.renderPin(n[e]));else for(let e=0;e<n.length;e++)t.appendChild(window.pin.renderPin(n[e]));e.appendChild(t)}}})(),(()=>{const e=window.const.MAP.clientWidth;let t=(e,t,n)=>{e.setAttribute("value",t+", "+n)};window.const.MAP_PIN_MAIN.addEventListener("mousedown",(n=>{n.preventDefault();let o={x:n.clientX,y:n.clientY},i=parseInt(window.const.MAP_PIN_MAIN.style.left,10)+32,r=parseInt(window.const.MAP_PIN_MAIN.style.top,10)+70;t(window.const.ADDRESS,i,r);let d=n=>{let d=o.x-n.clientX,s=o.y-n.clientY,l=window.const.MAP_PIN_MAIN.offsetLeft-d,c=window.const.MAP_PIN_MAIN.offsetTop-s;o={x:n.clientX,y:n.clientY},l>=-32&&l+32<=e&&(window.const.MAP_PIN_MAIN.style.left=l+"px"),c+70>=130&&c+70<=630&&(window.const.MAP_PIN_MAIN.style.top=c+"px"),i=parseInt(window.const.MAP_PIN_MAIN.style.left,10)+32,r=parseInt(window.const.MAP_PIN_MAIN.style.top,10)+70,t(window.const.ADDRESS,i,r)},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)}))})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error");let o=()=>{const t=n.cloneNode(!0);e.appendChild(t),document.querySelector(".error__button").addEventListener("click",(()=>{window.util.hideElement(t,"hidden")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&window.util.hideElement(t,"hidden")})),document.addEventListener("click",(()=>{window.util.hideElement(t,"hidden")}))};const i=()=>{(()=>{const n=t.cloneNode(!0);e.appendChild(n),document.addEventListener("keydown",(e=>{"Escape"===e.key&&window.util.hideElement(n,"hidden")})),document.addEventListener("click",(()=>{window.util.hideElement(n,"hidden")}))})(),window.const.AD_FORM.reset(),window.main.deactivatePage()};window.const.AD_FORM.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(window.const.AD_FORM);window.backend.saveData(t,i,o)}))})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]};window.const.AD_FORM.price.addEventListener("input",(()=>{window.const.AD_FORM.price.min=e[window.const.AD_FORM.type.value],window.const.AD_FORM.price.placeholder=e[window.const.AD_FORM.type.value],window.const.AD_FORM.price.value<e[window.const.AD_FORM.type.value]?window.const.AD_FORM.price.setCustomValidity("Недопустимая цена"):window.const.AD_FORM.price.setCustomValidity(""),window.const.AD_FORM.price.reportValidity()})),window.const.AD_FORM.timein.addEventListener("input",(e=>{e.target===window.const.AD_FORM.timein?window.const.AD_FORM.timeout.value=window.const.AD_FORM.timein.value:window.const.AD_FORM.timein.value=window.const.AD_FORM.timeout.value})),window.const.AD_FORM.timeout.addEventListener("input",(e=>{e.target===window.const.AD_FORM.timeout?window.const.AD_FORM.timein.value=window.const.AD_FORM.timeout.value:window.const.AD_FORM.timeout.value=window.const.AD_FORM.timein.value})),window.const.AD_FORM.capacity.addEventListener("input",(()=>{t[window.const.AD_FORM.rooms.value].includes(window.const.AD_FORM.capacity.value)?window.const.AD_FORM.capacity.setCustomValidity(""):window.const.AD_FORM.capacity.setCustomValidity("Недопустимое количество гостей"),window.const.AD_FORM.capacity.reportValidity()}))})(),(()=>{const e="map--faded",t=document.querySelector(".map__filters"),n=document.querySelector(".map__features"),o=Array.from(t.children),i=Array.from(n.children),r=Array.from(window.const.AD_FORM.querySelectorAll(".ad-form > fieldset")),d="ad-form--disabled";let s=t=>{0!==t.button&&"Enter"!==t.key||(window.util.showElement(window.const.MAP,e),window.util.disableElements(r,!1),window.util.showElement(window.const.AD_FORM,d)),window.const.MAP.querySelectorAll(".map__pin").length>=2&&(window.util.disableElements(o,!1),window.util.disableElements(i,!1))};window.util.disableElements(o,!0),window.util.disableElements(r,!0),window.util.disableElements(i,!0),window.const.MAP_PIN_MAIN.addEventListener("mousedown",s),window.const.MAP_PIN_MAIN.addEventListener("keydown",s),window.backend.loadData((e=>{window.util.disableElements(o,!1),window.util.disableElements(i,!1),window.offer.renderOffers(e),window.filter.filterOffers(e)}),(e=>{window.util.createErrorMessage(e),window.util.disableElements(o,!0),window.util.disableElements(i,!0)})),window.main={deactivatePage:()=>{window.util.hideElement(window.const.MAP,e),window.util.disableElements(o,!0),window.util.disableElements(i,!0),window.util.disableElements(r,!0),window.util.hideElement(window.const.AD_FORM,d)}}})()})();